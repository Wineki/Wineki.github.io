<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  
  <title>Thinkjs实现异步加载 | Wineki Blog</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  <meta name="description" content="今天来总结一下关于使用Thinkjs来实现页面异步加载的原理和做法。我从前端讲起，首先流程中包含一下几部分：



View
Controller
Model




筛选框（filter）用于筛选内容，位置在母模版
母模版对应的Action
调用数据库


异步加载内容（content），位置在子模板
ajax判断后的处理
调用数据库



下面根据代码具体解释一下：母模版的view层demo：">
<meta property="og:type" content="article">
<meta property="og:title" content="Thinkjs实现异步加载">
<meta property="og:url" content="http://www.imwineki.cn/2015/12/14/Thinkjs实现异步加载模板方法/index.html">
<meta property="og:site_name" content="Wineki Blog">
<meta property="og:description" content="今天来总结一下关于使用Thinkjs来实现页面异步加载的原理和做法。我从前端讲起，首先流程中包含一下几部分：



View
Controller
Model




筛选框（filter）用于筛选内容，位置在母模版
母模版对应的Action
调用数据库


异步加载内容（content），位置在子模板
ajax判断后的处理
调用数据库



下面根据代码具体解释一下：母模版的view层demo：">
<meta property="og:updated_time" content="2015-12-20T08:36:49.000Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="Thinkjs实现异步加载">
<meta name="twitter:description" content="今天来总结一下关于使用Thinkjs来实现页面异步加载的原理和做法。我从前端讲起，首先流程中包含一下几部分：



View
Controller
Model




筛选框（filter）用于筛选内容，位置在母模版
母模版对应的Action
调用数据库


异步加载内容（content），位置在子模板
ajax判断后的处理
调用数据库



下面根据代码具体解释一下：母模版的view层demo：">
  
    <link rel="alternative" href="/atom.xml" title="Wineki Blog" type="application/atom+xml">
  
  
    <link rel="icon" href="/favicon.png">
  
  <link href="//fonts.googleapis.com/css?family=Source+Code+Pro" rel="stylesheet" type="text/css">
  <link rel="stylesheet" href="/css/style.css" type="text/css">
  

</head>
<body>
  <div id="container">
    <div id="wrap">
      <header id="header">
  <div id="banner"></div>
  <div id="header-outer" class="outer">
    <div id="header-title" class="inner">
      <h1 id="logo-wrap">
        <a href="/" id="logo">Wineki Blog</a>
      </h1>
      
    </div>
    <div id="header-inner" class="inner">
      <nav id="main-nav">
        <a id="main-nav-toggle" class="nav-icon"></a>
        
          <a class="main-nav-link" href="/">Home</a>
        
          <a class="main-nav-link" href="/archives">Archives</a>
        
      </nav>
      <nav id="sub-nav">
        
          <a id="nav-rss-link" class="nav-icon" href="/atom.xml" title="RSS Feed"></a>
        
        <a id="nav-search-btn" class="nav-icon" title="Search"></a>
      </nav>
      <div id="search-form-wrap">
        <form action="//google.com/search" method="get" accept-charset="UTF-8" class="search-form"><input type="search" name="q" results="0" class="search-form-input" placeholder="Search"><button type="submit" class="search-form-submit">&#xF002;</button><input type="hidden" name="sitesearch" value="http://www.imwineki.cn"></form>
      </div>
    </div>
  </div>
</header>
      <div class="outer">
        <section id="main"><article id="post-Thinkjs实现异步加载模板方法" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2015/12/14/Thinkjs实现异步加载模板方法/" class="article-date">
  <time datetime="2015-12-14T09:23:10.000Z" itemprop="datePublished">2015-12-14</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 class="article-title" itemprop="name">
      Thinkjs实现异步加载
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <p>今天来总结一下关于使用Thinkjs来实现页面异步加载的原理和做法。<br>我从前端讲起，首先流程中包含一下几部分：</p>
<table>
<thead>
<tr>
<th>View</th>
<th style="text-align:center">Controller</th>
<th style="text-align:right">Model</th>
</tr>
</thead>
<tbody>
<tr>
<td>筛选框（filter）用于筛选内容，位置在母模版</td>
<td style="text-align:center">母模版对应的Action</td>
<td style="text-align:right">调用数据库</td>
</tr>
<tr>
<td>异步加载内容（content），位置在子模板</td>
<td style="text-align:center">ajax判断后的处理</td>
<td style="text-align:right">调用数据库</td>
</tr>
</tbody>
</table>
<p>下面根据代码具体解释一下：<br>母模版的view层demo：</p>
<pre><code><span class="xml">/*这里是一个filter*/
<span class="tag">&lt;<span class="title">div</span> <span class="attribute">class</span>=<span class="value">"filter"</span>&gt;</span>
    <span class="tag">&lt;<span class="title">dl</span> <span class="attribute">class</span>=<span class="value">"row"</span>&gt;</span>
        <span class="tag">&lt;<span class="title">dt</span>&gt;</span>大小<span class="tag">&lt;/<span class="title">dt</span>&gt;</span>
        <span class="tag">&lt;<span class="title">dd</span>&gt;</span>
            <span class="tag">&lt;<span class="title">a</span> <span class="attribute">href</span>=<span class="value">"#"</span>&gt;</span>全部<span class="tag">&lt;/<span class="title">a</span>&gt;</span>
            <span class="tag">&lt;<span class="title">a</span> <span class="attribute">href</span>=<span class="value">"#"</span>&gt;</span>大<span class="tag">&lt;/<span class="title">a</span>&gt;</span>
            <span class="tag">&lt;<span class="title">a</span> <span class="attribute">href</span>=<span class="value">"#"</span>&gt;</span>中<span class="tag">&lt;/<span class="title">a</span>&gt;</span>
            <span class="tag">&lt;<span class="title">a</span> <span class="attribute">href</span>=<span class="value">"#"</span>&gt;</span>小<span class="tag">&lt;/<span class="title">a</span>&gt;</span>
        <span class="tag">&lt;/<span class="title">dd</span>&gt;</span>
    <span class="tag">&lt;/<span class="title">dl</span>&gt;</span>
<span class="tag">&lt;/<span class="title">div</span>&gt;</span>
/*这里是一个content*/
<span class="tag">&lt;<span class="title">div</span> <span class="attribute">class</span>=<span class="value">"content"</span>&gt;</span>
    </span>&lt;%<span class="ruby"><span class="keyword">include</span> ajax/tplselectajax.html</span>%&gt;<span class="xml">     /*这里include进来一个子模板，将来异步刷新时就只刷新子模板数据*/
<span class="tag">&lt;/<span class="title">div</span>&gt;</span></span>
</code></pre><p>子模板的view层demo:<br>    可以看到从后端传来一个tpllist的数据字段，相当于是一个数组，我们把它循环输出出来，同时一会异步刷新的时候我们也只是刷新这个子模板的数据，而不会改变上面的母模板的数据。</p>
<pre><code><span class="xml"><span class="tag">&lt;<span class="title">div</span> <span class="attribute">class</span>=<span class="value">"cont-wrap"</span>&gt;</span>
    <span class="tag">&lt;<span class="title">ul</span>&gt;</span>
        </span><span class="vbscript">&lt;%tpllist.forEach(<span class="keyword">function</span>(item){ %&gt;</span><span class="xml">
            <span class="tag">&lt;<span class="title">li</span>&gt;</span>
                <span class="tag">&lt;<span class="title">p</span>&gt;</span></span><span class="vbscript">&lt;%=item.desc%&gt;</span><span class="xml"><span class="tag">&lt;/<span class="title">p</span>&gt;</span>
                <span class="tag">&lt;<span class="title">p</span>&gt;</span></span><span class="vbscript">&lt;%=item.name%&gt;</span><span class="xml"><span class="tag">&lt;/<span class="title">p</span>&gt;</span>
            <span class="tag">&lt;/<span class="title">li</span>&gt;</span>
        </span><span class="vbscript">&lt;%})%&gt;</span><span class="xml">
    <span class="tag">&lt;/<span class="title">ul</span>&gt;</span>
<span class="tag">&lt;/<span class="title">div</span>&gt;</span></span>
</code></pre><p>当然这里需要js来帮忙使用ajax来进行一步调用:</p>
<pre><code>$(<span class="string">'a'</span>).on(<span class="string">'click'</span>,<span class="function"><span class="keyword">function</span>(<span class="params">e</span>)</span>{
    e.preventDefault();
    $.ajax({
        url:<span class="string">''</span>,<span class="comment">/*填写请求路径*/</span>
        dataTpe:<span class="string">'jsonp'</span>,
        data:<span class="string">''</span>,<span class="comment">/*传送的数据*/</span>
        success:<span class="function"><span class="keyword">function</span>(<span class="params"></span>)</span>{

        },
        fail:<span class="function"><span class="keyword">function</span>(<span class="params"></span>)</span>{

        }

    });
});
</code></pre><p>Controller层的处理:</p>
<pre><code>tplselectAction: <span class="function"><span class="keyword">function</span><span class="params">()</span></span>{
    <span class="keyword">var</span> <span class="keyword">self</span> = this;
    <span class="comment">/*获取get请求的参数，在这个demo中其实就是筛选条件*/</span>
    <span class="keyword">var</span> data = this.get();  
    <span class="keyword">var</span> pg = data.pg;
    <span class="comment">/*判断时候是ajax请求，如果是则结果返回true*/</span>
    <span class="keyword">var</span> isAjax = <span class="keyword">self</span>.isAjax();   
    <span class="comment">/*子模板渲染路径，注意此处根目录是Home*/</span>
    <span class="keyword">var</span> tpl = <span class="string">'Home/ajax/build_tplselectajax.html'</span>;         
    <span class="keyword">if</span>(!isAjax){
        <span class="comment">/*如果不是ajax请求，也就是浏览器首次渲染数据时，默认选择展示全部数据*/</span>
        data = { cateId: <span class="string">'全部'</span>}
    }
    <span class="comment">/*调用数据库获取数据，调用ajaxdata方法*/</span>
    D(<span class="string">'Template'</span>).ajaxdata(data,pg).then(<span class="function"><span class="keyword">function</span><span class="params">(data)</span></span>{
        <span class="keyword">var</span> <span class="keyword">list</span> = shiftObject(data,<span class="string">'data'</span>);  <span class="comment">/*将数据库data字段整体存入list*/</span>
        <span class="keyword">self</span>.assign(<span class="string">'tpllist'</span>,<span class="keyword">list</span>);  
        <span class="keyword">self</span>.assign(<span class="string">'isAjax'</span>,isAjax);
        <span class="keyword">if</span>(isAjax){
            <span class="comment">/*如果是ajax模板，则利用fetch这个方法对模板进行重新渲染，并返回相应json格式的状态值*/</span>
            <span class="keyword">if</span>(<span class="keyword">list</span>.length !== <span class="number">0</span>){
                <span class="keyword">self</span>.fetch(tpl).then(<span class="function"><span class="keyword">function</span><span class="params">(content)</span></span>{
                   <span class="keyword">self</span>.jsonp({status:<span class="string">"success"</span>,cont:content});
                });
            }<span class="keyword">else</span>{
                <span class="keyword">self</span>.jsonp({status:<span class="string">"fail"</span>,cont:<span class="string">'暂时木有相应的模板，搜搜别的试试吧！'</span>});
            }
        }<span class="keyword">else</span>{
            <span class="comment">/*首次加载页面则直接展示*/</span>
            <span class="keyword">self</span>.display();
        }
    });
}
</code></pre><p>Model层的处理demo：</p>
<pre><code>ajaxdata: function(<span class="built_in">data</span>){
    <span class="built_in">var</span> <span class="built_in">self</span> = this;
    <span class="keyword">if</span>(<span class="built_in">data</span><span class="built_in">.</span>cateId = <span class="string">'全部'</span>){
        <span class="keyword">return</span> <span class="built_in">self</span><span class="built_in">.</span><span class="keyword">order</span>({<span class="string">'id'</span>:<span class="string">'desc'</span>})<span class="built_in">.</span><span class="keyword">select</span>()<span class="built_in">.</span>then(function(<span class="built_in">data</span>){
            <span class="keyword">return</span> <span class="built_in">data</span>;
        });
    }<span class="keyword">else</span>{
        <span class="keyword">return</span> <span class="built_in">self</span><span class="built_in">.</span><span class="keyword">where</span>({<span class="string">'title'</span>:<span class="built_in">data</span><span class="built_in">.</span>cateId})<span class="built_in">.</span><span class="keyword">order</span>({<span class="string">'id'</span>:<span class="string">'desc'</span>})<span class="built_in">.</span><span class="keyword">select</span>()<span class="built_in">.</span>then(function(<span class="built_in">data</span>){
            <span class="keyword">return</span> <span class="built_in">data</span>;    
        });
    }
}
</code></pre><p>Model层的处理：<br>这里是项目源代码的查询:</p>
<pre><code>ajaxdata: <span class="function"><span class="keyword">function</span><span class="params">(data,pg)</span></span>{
        var self = this;
        var <span class="keyword">where</span> = <span class="keyword">where</span> || {};
        /*此处包含其他参数的复合查询，展示出来，在demo中暂时不考虑*/
        /*var join = {
            templatecate: {
                join: <span class="string">'left'</span>,
                as: <span class="string">'c'</span>,
                on: [<span class="string">'cateId'</span>,<span class="string">'id'</span>]
            }
        };
        var pg = pg || (isNumber(<span class="keyword">where</span>) ? <span class="keyword">where</span> : null);
        var lastCond = {};
        <span class="keyword">if</span>(<span class="comment">!isEmpty(where)){</span>
            for(var i <span class="type">in</span> <span class="keyword">where</span>){
                var find = false;
                for(var s <span class="type">in</span> fields){
                    <span class="keyword">if</span>(fields[s].indexOf(i) &gt; -<span class="number">1</span>){
                        lastCond[s + <span class="string">'.'</span> + i] = <span class="keyword">where</span>[i];
                        find = true;
                        break;
                    }
                }
                <span class="keyword">if</span>(find)<span class="keyword">continue</span>;
                lastCond[<span class="string">'t.'</span> + i] = <span class="keyword">where</span>[i];
            }
        }*/
        <span class="keyword">if</span>(<span class="type">data</span>.cateId == <span class="string">'全部'</span>){
            var per = C(<span class="string">'db_nums_per_page'</span>);
            /*在筛选框为‘全部’时，将数据中全部数据按条件查询出来，并且进行分页查询（分页查询此处我们暂时不讨论）*/
            <span class="keyword">return</span> self.<span class="keyword">where</span>({<span class="string">'endType'</span>:<span class="type">data</span>.<span class="keyword">endType</span>,<span class="string">'isForbidden'</span>:<span class="number">0</span>}).order({<span class="string">'id'</span>: <span class="string">'desc'</span>}).page(pg).<span class="keyword">select</span>().<span class="keyword">then</span>(<span class="function"><span class="keyword">function</span><span class="params">(data)</span></span>{
                    <span class="keyword">return</span> <span class="type">data</span>;
            }).<span class="keyword">then</span>(<span class="function"><span class="keyword">function</span><span class="params">(datalist)</span></span>{
                /*将返回结果进行处理，并返回相应的参数*/
                <span class="keyword">return</span> self.field(<span class="string">'count(id) as count'</span>).<span class="keyword">where</span>({<span class="string">'endType'</span>:<span class="type">data</span>.<span class="keyword">endType</span>}).find().<span class="keyword">then</span>(<span class="function"><span class="keyword">function</span><span class="params">(res)</span></span>{
                    <span class="keyword">return</span> {
                        <span class="type">data</span>: datalist,
                        <span class="built_in">count</span>: res.<span class="built_in">count</span>,
                        page: pg || <span class="number">1</span>,
                        num: per,
                        total: Math.ceil(res.<span class="built_in">count</span> / per)
                    };
                });
            }); 
        }<span class="keyword">else</span>{
            /ajax请求是查询结果，按照cateId的值进行查询/
            var per = C(<span class="string">'db_nums_per_page'</span>);
            <span class="keyword">return</span> self.alias(<span class="string">'t'</span>).field(<span class="string">'t.*'</span>).join(join).<span class="keyword">where</span>({<span class="string">'c.title'</span>:<span class="type">data</span>.cateId,<span class="string">'t.endType'</span>:<span class="type">data</span>.<span class="keyword">endType</span>,<span class="string">'isForbidden'</span>:<span class="number">0</span>}).order({<span class="string">'t.id'</span>: <span class="string">'desc'</span>}).page(pg).<span class="keyword">select</span>().<span class="keyword">then</span>(<span class="function"><span class="keyword">function</span><span class="params">(data)</span></span>{
                    <span class="keyword">return</span> <span class="type">data</span>;
            }).<span class="keyword">then</span>(<span class="function"><span class="keyword">function</span><span class="params">(datalist)</span></span>{
                <span class="keyword">return</span> self.alias(<span class="string">'t'</span>).field(<span class="string">'count(t.id) as count'</span>).join(join).<span class="keyword">where</span>({<span class="string">'c.title'</span>:<span class="type">data</span>.cateId,<span class="string">'t.endType'</span>:<span class="type">data</span>.<span class="keyword">endType</span>}).find().<span class="keyword">then</span>(<span class="function"><span class="keyword">function</span><span class="params">(res)</span></span>{
                    <span class="keyword">return</span> {
                        <span class="type">data</span>: datalist,
                        <span class="built_in">count</span>: res.<span class="built_in">count</span>,
                        page: pg || <span class="number">1</span>,
                        num: per,
                        total: Math.ceil(res.<span class="built_in">count</span> / per)
                    };
                });
            }); 
        }

    }
</code></pre><p>关于Thinkjs里面的具体语法我就不一一解释了，这里主要来讲一下大概的思路，首先前端需要在模板中将需要异步加载的模板进行include,方便后续的异步刷洗页面，同时你需要用js来进行一个ajax的通信，接着就是Controller层对模板的渲染，在拿到前端传来的请求数据后，调用model层的方法从数据库中取出数据，此时需要使用feteh这个方法重新渲染页面。（其实也可以使用display(渲染模板路径)这个方法，只是渲染的方式不用而已，结果是一样的）感兴趣的同学可以搜一下API。<br>sql语句写的不好，还望大家见谅~~哈哈哈，先就这么多~</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://www.imwineki.cn/2015/12/14/Thinkjs实现异步加载模板方法/" data-id="cind9mk2v0005gmwgv5u67q0p" class="article-share-link">Share</a>
      
      
    </footer>
  </div>
  
    
<nav id="article-nav">
  
    <a href="/2016/01/25/HTTP解读（一）/" id="article-nav-newer" class="article-nav-link-wrap">
      <strong class="article-nav-caption">Newer</strong>
      <div class="article-nav-title">
        
          HTTP解读（一）
        
      </div>
    </a>
  
  
    <a href="/2015/11/25/css选择器优先级权重分析/" id="article-nav-older" class="article-nav-link-wrap">
      <strong class="article-nav-caption">Older</strong>
      <div class="article-nav-title">css选择器优先级权重分析</div>
    </a>
  
</nav>

  
</article>

</section>
        
          <aside id="sidebar">
  
    
  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Tags</h3>
    <div class="widget">
      <ul class="tag-list"><li class="tag-list-item"><a class="tag-list-link" href="/tags/HTTP-web传输/">HTTP web传输</a><span class="tag-list-count">1</span></li></ul>
    </div>
  </div>

  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Tag Cloud</h3>
    <div class="widget tagcloud">
      <a href="/tags/HTTP-web传输/" style="font-size: 10px;">HTTP web传输</a>
    </div>
  </div>

  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Archives</h3>
    <div class="widget">
      <ul class="archive-list"><li class="archive-list-item"><a class="archive-list-link" href="/archives/2016/04/">April 2016</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2016/02/">February 2016</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2016/01/">January 2016</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2015/12/">December 2015</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2015/11/">November 2015</a><span class="archive-list-count">2</span></li></ul>
    </div>
  </div>

  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Recents</h3>
    <div class="widget">
      <ul>
        
          <li>
            <a href="/2016/04/19/基于canvas统计图实现/">基于canvas统计图实现</a>
          </li>
        
          <li>
            <a href="/2016/02/05/HTTP解读（二）/">HTTP解读（二）</a>
          </li>
        
          <li>
            <a href="/2016/01/25/HTTP解读（一）/">HTTP解读（一）</a>
          </li>
        
          <li>
            <a href="/2015/12/14/Thinkjs实现异步加载模板方法/">Thinkjs实现异步加载</a>
          </li>
        
          <li>
            <a href="/2015/11/25/css选择器优先级权重分析/">css选择器优先级权重分析</a>
          </li>
        
      </ul>
    </div>
  </div>

  
</aside>
        
      </div>
      <footer id="footer">
  
  <div class="outer">
    <div id="footer-info" class="inner">
      &copy; 2016 Wineki<br>
      Powered by <a href="http://hexo.io/" target="_blank">Hexo</a>
    </div>
  </div>
</footer>
    </div>
    <nav id="mobile-nav">
  
    <a href="/" class="mobile-nav-link">Home</a>
  
    <a href="/archives" class="mobile-nav-link">Archives</a>
  
</nav>
    

<script src="//ajax.googleapis.com/ajax/libs/jquery/2.0.3/jquery.min.js"></script>


  <link rel="stylesheet" href="/fancybox/jquery.fancybox.css" type="text/css">
  <script src="/fancybox/jquery.fancybox.pack.js" type="text/javascript"></script>


<script src="/js/script.js" type="text/javascript"></script>

  </div>
</body>
</html>